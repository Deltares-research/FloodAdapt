---
title:	Delft-FIAT model-builder
filters:
  - lightbox
lightbox: auto
execute:
  echo: false
jupyter: python3
number-sections: false
format: html
---

The Delft-FIAT model builder was designed to make it easy for analysts to set up a Delft-FIAT model. The model-builder can be used to automatically generate a Delft-FIAT model or to create a tailored model using local data. In both cases, the user starts by selecting their working directory and choosing their area of interest (model boundary). They can then use the [quick-build](#sec-quickbuild) option to automatically generate a Delft-FIAT model, or they can use additional functionality to build a [tailored Delft-FIAT model](#sec-tailored_model). Because the quick-build option does not require modeling experience, the model-builder makes the generation of Delft-FIAT models accessible to a wide audience. 

This guide is organized in six sections: 

(1) [Get started](#getting-started) when you open the Model Builder
(2) [Selecting your area of interest](#model-boundary) (your "model boundary"). 
(3) [Building a Delft-FIAT model with the quick-build option](#sec-quickbuild) (automatic model generation with open data). 
(4) [Building a tailored Delft-FIAT model](#sec-tailored_model) using local data or different settings than the default options. 
(5) [Visualizing](#visualize-your-model) the model you've created
(6) [Understanding the Delft-FIAT model folder](#delft-fiat-model-folder) that is generated

@fig-homeScreen shows the Delft-FIAT model builder. There are seven tabs shown at the top. For generating an automatic Delft-FIAT model using open data, you will only need to use the first of these tabs, the "Model Boundary | Quick Build" tab. The remaining tabs are for tailoring your Delft-FIAT model and are described in the [tailored Delft-FIAT model](#sec-tailored_model) section. 

![The model-builder start screen. The tabs at the top walk you through the key components of a Delft-FIAT model for FloodAdapt.](../../_static/images/model_builder_homeScreen.png){width=50% fig-align=left #fig-homeScreen}

## Getting started {#sec-getting-started}

The initial steps to set up a Delft-FIAT model are the same whether you set up a [quickbuild](#sec-quickbuild) or [tailored](#sec-tailored_model) model. To get started building your Delft-FIAT model:

* Open the Model Builder application; this contains functionality to build a SFINCS and a Delft-FIAT model
*  Click "Model" in the top menu bar and choose "FIAT"
*  Click "File" in the top menu bar and choose "Select Working Directory"
* Select an existing folder or create a new one

## Model boundary

The Delft-FIAT **model boundary** encapsulates the area of interest where you want to calculate flood damages. To specify your model boundary, go to the Model Boundary | Quickbuild tab. In the "Model Boundary" box, you will select *how* you would like to specify your model boundary. There are four options:

  * Draw polygon: Click on the map and draw a polygon. Double click when finished.
  * Draw box: Click on the map and draw a box. Double click when finished.
  * SFINCS model domain: If you already created a SFINCS model you can select the folder where your SFINCS model is saved. Do <u>not</u> select the region file itself. It will be recognized automatically when you select your SFINCS folder.
  * Upload file: You can upload a boundary using a geospatial file (e.g. *.gpkg*, *.geojson*). 

When you are finished, click "Generate Boundary", and your model area will be created. 


::: {.callout-note}
##### Which model boundary option should I choose?
When setting up FloodAdapt in a project area, you will also have to set up a SFINCS model for the flood estimation. You may want to have your damage model active everywhere where there will be flood information. If that is the case, choose the "SFINCS model domain". 

Sometimes the flood model extent is actually much larger than your area of interest (this is because water from outside your area of interest may still make its way to your area of interest). If this is the case, you can better pick one of the other options. 

* To look at damages for an adminstative area like a city or a county, you can best upload the city or county boundary shapefile using the "Upload file" option
* To quickly get started and you don't have a city or county shapefile on hand, you can draw a polygon or box in the map around the area you are interested in. 
:::

<!-- I am commenting out the below because I actually think it makes it more confusing instead of clearer. 
![Workflow to create model boundaries.](../../_static/figures/draw_boundaries.svg){#fig-boundaries}


::: {.callout-note}
After you selected the working directory the Delft-FIAT model builder generates the folder structure as described in the section [Folder Structure](index.qmd) in the output folder.
:::
-->
::: {.callout-tip}
##### Watch a video tutorial for selecting a model boundary with the "draw polygon" option
{{< video https://youtu.be/gaViRtw9p1o?rel=0 >}}
:::

## Quick Build {#sec-quickbuild} 
The Quick Build option allows users to set up a Delft-FIAT model anywhere with ease; it doesn't require any user input except for defining the [model boundary](#sec-getting-started). The quick build option sets up the exposure data for buildings and roads, and assigns the corresponding vulnerability curve to each asset. The model-builder also downloads [equity data (income and population)](#sec-equity) for the equity-weighting functionality in FloodAdapt.

To use the quick build option to generate a Delft-FIAT model, simply click the "Create model" button on the "Model Boundary | Quick Build" tab after generating your model boundary. That's it!


::: {.callout-note}
##### Where does the data for the Quick Build option come from?
The Quick Build option uses open data from several sources. 

For the United States, the data sources are:

* **Exposure**: [National Structure Inventory (NSI)](https://www.hec.usace.army.mil/confluence/nsi)
* **Vulnerability curves**: FEMA HAZUS 4.0 SQL database, obtained through [FEMA FAST repository](https://github.com/nhrap-hazus/FAST/tree/main/Lookuptables)
* **Socio-economic/equity data**: US census data
* **Roads**: Open Street Map (OSM)

Outside the United States, the data sources are (note: no socio-economic data are downloaded by default outside of the U.S>)

* **Exposure**: Open Street Maps (OSM)
* **Vulnerability curves**: [Joint Research Centre](https://publications.jrc.ec.europa.eu/repository/handle/JRC105688)
* **Roads**: Open Street Map (OSM)
:::

<!--
![Workflow about how to use the "Quickbuild"-option.](../../_static/figures/quickbuild.svg){#fig-quickbuild}
-->

::: {.callout-tip}
##### Watch a video tutorial for building a Delft-FIAT model with the Quick Build option
{{< video https://youtu.be/PYaBQ0DVo78?rel=0 >}}
:::

## Tailored Delft-FIAT model {#sec-tailored_model}
Using local data can help improve the accuracy of damage estimates and utility of infometrics. The Delft-FIAT model builder enables you to create a base model and then refine the model using available local data.

When creating a tailored Delft-FIAT model, there are three mandatory steps. These are:

1. [Set up a base exposure dataset](#sec-basemodel)
2. [Add vulnerability curves](#sec_vulnerability)
3. [Create your Delft-FIAT model](#sec-createModel)

In addition to these mandatory steps, there are many options to refine data sources and default options. When creating a tailored Delft-FIAT model, you always start by building a [base exposure dataset](#sec-basemodel) using open data, which can then be refined. The Delft-FIAT model tabs (see Figure x) — Exposure, Vulnerability, Equity, and Additional Attributes — enable specific refinements, which are highlighted in the list below and detailed in the following sections.  

* [Step 1: Set up a base exposure dataset](#sec-basemodel)
* [Exposure updates](#sec_update_exposure)
<!--* **SHOULDN'T CLASSIFICATION BE HERE TOO?** -->
  * [Update finished floor heights of buildings](#sec-finished_floor_height)
  * [Update the ground elevation at the asset locations](#sec-ground_elevation)
  * [Update the maximum potential damages (structure and content) of the assets](#sec-maximum_potential_damages)
* [Vulnerability](#sec_vulnerability)
  * [Assign default vulnerability curves](#sec_vulnerability)
  * [Change vulnerability curves](#sec_update_vulnerability)
* [Equity](#sec-equity)
  * Add income and population data for equity-weighting in FloodAdapt
* [Additional Attributes](#sec-addl-attributes)
  * Add flexible attributes that are important for deriving metrics or visualizing in FloodAdapt

### Create a base exposure dataset {#sec-basemodel}
Similar to the Quick Build option, the base exposure dataset is generated using open data. When your model is within the United States, [National Structure Inventory](https://www.hec.usace.army.mil/confluence/nsi) data is used to generate the base exposure dataset for buildings, and open street map (OSM) is used to generate the data for roads. When your model is outside of the United States, OSM is used to generate the base exposure dataset for both buildings and roads. 

To set up the base exposure dataset: 

* Generate your [model boundary](#model-boundary).
* Open the "Exposure" tab from the top panel. From the bottom panel select the "Asset Location" tab.
* Select the correct data source for your model. 
  * For a U.S. based model choose "Start with National Structure Inventory (NSI)"
  * For a model outside of the U.S. choose "Start with Open Street Map (OSM)"
* Include road data by checking the checkbox "Include OSM roads".
* Click the button "Add to model".


::: {.callout-warning}
##### Extra settings for models outside the U.S. 
When choosing to start with open street map, the model-builder asks the user to specify a damage unit and a finished floor height. 

* Damage unit (currency): Do not change the default currency from Euro to another currency. There is no currency converter tool implemented in the Delft-FIAT model builder yet.
* Finished floor height: OSM exposure data does not include this attribute. The user can select a single value that will be applied to all buildings. They can [refine this later using spatial data](#sec-finished_floor_height). 
:::



<!--![Workflow to setup exposure data with NSI (National Structure Inventory) or OSM (Open Street Map) as data source.](../../_static/figures/exposure.svg){width=30% fig-align=left #fig-exposure}
-->

    ::: {.callout-tip}
    You can refine the finished floor height for the individual assets in the **Exposure**- >> **Finished Floor Height**-tab.
    :::

4. Include **OSM roads** by checking the checkbox "Include OSM roads".
5. Add to model.

The video tutorials demonstrate the exposure setup using the NSI exposure and OSM roads (@fig-nsi_exposure) as well as the exposure setup for a global model, using OSM data (incl. roads; @fig-osm_exposure).

![Workflow to setup exposure data with NSI (National Structure Inventory) or OSM (Open Street Map) as data source.](../../_static/figures/exposure.svg){#fig-exposure}

After completing the steps outlined above the "default" exposure for a **base model** is fully established.  


After completing the steps outlined above the "default" exposure for a **base model** is fully established.  


::: {#fig-nsi_exposure}

{{< video ../../_static/videos/hydromt_fiat/Exposure_NSI.mp4 >}}

Exposure setup in the United States using NSI exposure and OSM roads.

:::


::: {#fig-osm_exposure}

{{< video ../../_static/videos/hydromt_fiat/Exposure_OSM.mp4 >}}

Global exposure setup using OSM exposure and OSM roads .

::: {.callout-note}
##### Optional settings for spatially joining exposure points and finished floor height data
In the "Finished Floor Height" tab there is a "Settings" button. This allows you to change default choices related to the spatial join of the exposure data points and the uploaded finished floor height data. Default settings use the *nearest* method for points and the *intersection* method for polygons when doing the spatial join. The default maximum distance for the *nearest* method is 10 meters. 
:::

::: {.callout-tip}
##### Watch a video tutorial for updating the finished floor height of buildings in your Delft-FIAT model 

Coming soon...
:::

#### Updating ground elevation {#sec-ground_elevation}
To update ground elevation data, you must provide a digital elsevation model (DEM) raster file. The Delft-FIAT model builder calculates the mean elevation within the shape of each asset and assigns this value to the associated asset.   

::: {.callout-note}
##### Important note for those who will use the FloodAdapt database builder 
If you will use the **FloodAdapt database builder **to create your FloodAdapt database, it will automatically overwrite the ground elevation data in your Delft-FIAT model to match what is in your SFINCS model, so you do not need to do that manually here!
:::

<!--![Workflow to refine the ground elevation.](../../_static/figures/ground_elevation.svg){#fig-ground_elevation}
-->
To update the ground elevation values in your Delft-FIAT model: 

1. Open the **Exposure** tab on the top panel and select the **Ground Elevation** tab in the bottom panel.
2. Select a ground elevation source. There are two options in the drop-down menu:
    * SFINCS Ground Elevation
        * If you have already a SFINCS model set up, select the folder that contains your SFINCS model. The Delft-FIAT model builder knows the location of the DEM file within this folder.
    * Upload file
        * Select a DEM raster file
        * Select the elevation unit for your DEM (meters or feet).
3. Click "Add to model". 

::: {.callout-tip}
##### Watch a video tutorial for updating ground elevation in your Delft-FIAT model

Coming soon...
:::


#### Updating maximum potential damages {#sec-maximum_potential_damages}
When local data is available on maximum potential values, either for content or structure, these can be incorporated in the Delft-FIAT model using the Delft-FIAT model-builder. The maximum potential damages you want to use must be point or polygon data. Point data would be for asset-level information, and polygon data would be for cases where you want to assign the same values to a larger area. It is necessary to distinguish between structure and content maximum potential damages, as these are treated separately in the damage calculation. 

<!--![Workflow to refine the fmaximum potential damage (structure/content).](../../_static/figures/max_potential_damages.svg){#fig-max_potential_damages}
-->
To update the maximum potential damages: 

  1. Open the **Exposure** tab on the top panel and select the **Max Potential Damages** tab in the bottom panel. 
  2. Click "Select source" and select the file containing your maximum potential damage data (point or polygon data)
  3. Click "Load". This will load the data columns in your file into the "Attribute ID" drop-down menu.
  4. Select the column that holds the max. potential damage data.
  5. Select the damage type you wish to update, either "structure" or "content".  
  6. Add to model.

::: {.callout-note}
The Delft-FIAT model builder performs a spatial joint of the exposure assets with the point-/polygon max. potential damages vector file and assigns the new values to the intersecting/nearest asset.
:::

![Workflow to refine the fmaximum potential damage (structure/content).](../../_static/figures/max_potential_damages.svg){#fig-max_potential_damages}

<u>*Step-by-step instructions: Import the Max. Potential Damages*</u>   

  1. Open the **"Exposure"**-tab on the top panel and select the **"Max. Potential Damages"**-tab in the bottom panel. 
  2. Select the file source of your max. potential damage data. The file must be a point- or polygon vector file (e.g. *.gpkg*, *.geojson*).
  3. Load the file. This will load the data columns in your file into the **Attribute ID** drop-down menu.
  4. Select the column that holds the max. potential damage data (either "structure"or "content").
  5. Select the damage type you wish to update, either *structure* or *content*.  
  6.  *optional settings*: Define the method for the spatial joint. The default for point data is *'nearest'* and for polygon data *'intersection'*. The default will be automatically selected by the Delft-FIAT model builder. You can keep the default settings if you don't wish to change the method.
  7. Add to model.

  ::: {#fig-max_pot_damages}

{{< video ../../_static/videos/hydromt_fiat/Max_potential_damages.mp4 >}}

Model refinement with user input for maximum potential damages. 

:::

  ::: {#fig-max_pot_damages}

{{< video ../../_static/videos/hydromt_fiat/Max_potential_damages.mp4 >}}

Model refinement with user input for maximum potential damages. 

:::

### Assign vulnerability curves
Delft-FIAT calculates the damages on the bases on vulnerability curves. There are two data sources which the vulnerability curves can be downloaded from, determined by the location of your model:

1. **United States:** FEMA Hazus Curves
2. **Global:** JRC Vulnerability Curves

<u>*Step-by-step instructions: Assign vulnerability curves*</u>

  1. Open the **"Vulnerability"**-tab on the top panel (@fig-vulnerability_curve). 
  2. The Delft-FIAT model builder will **automatically** select the **default data source** based upon your exposure data (NSI or global). Therefore, you only need to add the curves to the model without further adjustment. 
  3. ***Only NSI***: If desired, you can specify different curves from the default  by selecting "Specify different damage curves". First, select the asset you want to assign another damage curve to and second, select a new damage curve (@fig-update_curves). 

![Workflow to assign vulnerability curves to assets with option to update default NSI vulnerability curves.](../../_static/figures/vulnerability.svg){#fig-vulnerability_curve}

You can follow the steps in the video below (@fig-vulnerability).

::: {#fig-vulnerability}

{{< video ../../_static/videos/hydromt_fiat/NSI_Vulnerability.mp4 >}}

Assign the default vulnerability curves to the exposure data. 

:::


Assign the default vulnerability curves to the exposure data. 

:::

::: {#fig-update_curves}

{{< video ../../_static/videos/hydromt_fiat/Update_default_damage_curve.mp4 >}}

***Only NSI***: Update default vulnerability curves. 

:::

### Additional features
#### Social Vulnerability Index (SVI) and Equity {#sec-svi}
Delft-FIAT allows you to evaluate the equitible distribution of damages and benefits by using the **social vulnerability index** and **equity**. If your model site is located in the United States, SVI data can be calculated based upon recent literature. 
However, you have the freedom to upload any social vulnerability index and/or equity layer in form of a **vector file** (e.g. *.gpkg*, *.geojson*) and assign a value to each asset that overlaps the layer at any location (please refer to section [Additional Attributes](#sec-add_attributes)).

<u>*Step-by-step instructions: Download SVI and equity data (United States)*</u>  

  1. Open the **"SVI + Equity"**-tab on the top panel.
  2. In the bottom panel, select the year you wish to download data frame.
  3. Check the checkboxes to download, SVI and/or Equity data.

If your model is setup in a location outside the U.S please refer to the section [Additional Attributes](#sec-add_attributes) for instructions. 

For a detailed demonstration please refer to @fig-svi_equity.

::: {#fig-svi_equity}

{{< video ../../_static/videos/hydromt_fiat/SVI_and_Equity_detail.mp4 >}}

Add additional attributes to your model. In this example, a land use layer is added to the model, and assets are assigned to the land use category that encompasses each asset. 

:::

#### Additional attributes {#sec-add_attributes}
Not only social vulnerability and/or equity can be linked to the exposure data. Any additional layer (e.g. landuse, administrative boundaries or others) can be added to your model (@fig-svi). The additional attribute layer must be a **vector file** (e.g. *.gpkg*, *.geojson*) in the same geographical location of your model. 

<!--![Adding SVI/Equity and additional attributes (e.g. landuse) to the model](../../_static/figures/SVI_additional_attr.svg){#fig-svi}
-->

To add an additional attribute layer to your model:

* Open the **Additional Attributes** tab on the top panel.
* Click "Select source" and choose your file. 
* Click "Load". This will load the data columns in your file into the "Attribute ID" drop-down menu.
* From the "Attribute ID" drop-down, select the attribute you wish to add to your model. 
* Add a name in the "Label" box. This label will be the column name of your attribute in the Delft-FIAT exposure (and output) data. 
* Click "Add". The layer will appear in the table in the "Overview attribute" table. 
* In the bottom of the "Overview attribute" panel, you can check the "Display Attribute" checkbox to verify your data was added correctly. 
* You can repeat this process for as many layers as you wish.
* When finished adding layers, click "Add to model".
 
<!--::: {#fig-additional_attr}

{{< video ../../_static/videos/hydromt_fiat/Additional_Attributes_NSI.mp4 >}}

Add additional attributes to your model. In this example, a land use layer is added to the model, and assets are assigned to the land use category that encompasses each asset. 

:::
-->
::: {.callout-tip}
##### Watch a video tutorial for adding additional attributes to your Delft-FIAT model

Coming soon...
:::

### Create model  {#sec-createModel}

At this point you are ready to create your Delft-FIAT model.  Open the **Create Model** tab on the top panel and verify the data sources in the bottom tab are as expected. If so, click "Create Delft-FIAT model".

## Visualize your model
Once you have created your model, you can visualize different model attributes on the **View Model** tab. The attributes that can be displayed in the map window are:

* Asset classification (primary or secondary)
* Finished floor height
* Max potential damages (structure or content)
* Ground elevation
* Additional attributes
* Roads

There is also a button "Exposure output". This opens the full model data, which is also stored as a CSV in the model output folder. This allows you to quickly view the complete dataset without having to look for the file on your computer. 

::: {.callout-tip}
##### Watch a video tutorial for visualizing your Delft-FIAT model 

Coming soon...
:::

## Delft-FIAT model folder
Once you have created your model, the model folder you specified when you chose your working directory in the [getting started](#getting-started) step will be populated with the Delft-FIAT model files. This folder structure will be described...**coming soon**...

<!--
Figure x shows what the folder structure looks like, for a working directory named "FIAT". 

├───📁 FIAT/
    |
    ├───📁 hazard/
    │   └───📄 This will be empty
    |
    ├───📁 exposure/
    │   ├───📄 buildings.gpkg
    │   └───📄 exposure.csv
    |
    ├───📁 vulnerability/
    │   └───📄 vulnerability_curves.csv
    |
    └───📄 settings.toml
-->